# WiX 6 MSI Installer Project Modification Plan

## Project Overview
Modify the existing WiX 6 installer project to build a parameterized MSI installer for the Sample WPF Application, supporting both local development and GitHub Actions CI/CD scenarios.

## Current State Analysis

### Existing Files in WixMsi Folder:
- `WixMsi.wixproj` - Basic WiX project file with project reference
- `Package.wxs` - Main package definition with hardcoded values
- `AppComponents.wxs` - Simple component group with only 4 core files
- `Folders.wxs` - Basic folder structure definition
- `Package.en-us.wxl` - Localization file with minimal strings

### Current Limitations:
1. Only includes 4 core application files, missing ~200+ runtime dependencies
2. Hardcoded version (1.0.0.0) and other properties
3. No parameterization for different build scenarios
4. Missing desktop shortcuts, Start Menu entries, and uninstall features
5. No support for localized resource files
6. Basic folder structure without proper organization

## Modification Plan

### 1. Project File Enhancements (`WixMsi.wixproj`)

**Changes Required:**
- Add MSBuild properties for parameterization
- Define default values for local development
- Add conditional properties for CI/CD scenarios
- Include preprocessing capabilities

**New Properties to Add:**
```xml
<PropertyGroup>
  <!-- Version properties (can be overridden by build script) -->
  <PackageVersion Condition="'$(PackageVersion)' == ''">1.0.0.0</PackageVersion>
  <ProductVersion Condition="'$(ProductVersion)' == ''">1.0.0</ProductVersion>
  <ManufacturerName Condition="'$(ManufacturerName)' == ''">Bryan Knox</ManufacturerName>
  <ProductName Condition="'$(ProductName)' == ''">Sample WPF App</ProductName>

  <!-- File source properties -->
  <PublishedFilesPath Condition="'$(PublishedFilesPath)' == ''">$(MSBuildProjectDirectory)\..\local-published\SampleWpfApp-output</PublishedFilesPath>

  <!-- Build configuration -->
  <CreateDesktopShortcut Condition="'$(CreateDesktopShortcut)' == ''">true</CreateDesktopShortcut>
  <CreateStartMenuShortcut Condition="'$(CreateStartMenuShortcut)' == ''">true</CreateStartMenuShortcut>
</PropertyGroup>
```

### 2. Package Definition Updates (`Package.wxs`)

**Changes Required:**
- Replace hardcoded values with MSBuild properties
- Add upgrade logic for proper version handling
- Include proper package metadata
- Add feature organization

**Key Modifications:**
```xml
<Package
  Id="bryanknox.SampleWpfAppWixMsiPackage"
  Name="$(ProductName)"
  Manufacturer="$(ManufacturerName)"
  Version="$(PackageVersion)"
  UpgradeCode="YOUR-UPGRADE-CODE-GUID">

  <MajorUpgrade
    DowngradeErrorMessage="!(loc.DowngradeError)"
    AllowSameVersionUpgrades="yes" />

  <Feature Id="MainApplication" Title="$(ProductName)" Level="1">
    <ComponentGroupRef Id="AppComponents" />
    <ComponentGroupRef Id="RuntimeComponents" />
    <ComponentGroupRef Id="SubDirectoryComponents" />
  </Feature>

  <Feature Id="Shortcuts" Title="Shortcuts" Level="1">
    <ComponentGroupRef Id="ShortcutComponents" />
  </Feature>
</Package>
```

### 3. Application Components Overhaul (`AppComponents.wxs`)

**Current Issues:**
- Only includes 4 files out of ~200+ required files
- Missing all .NET runtime dependencies
- No support for localized resource folders

**Solution - New Component Structure:**

**3.1 Core Application Components:**
```xml
<ComponentGroup Id="AppComponents" Directory="INSTALLFOLDER">
  <Component Id="MainExecutable">
    <File Source="$(var.PublishedFilesPath)\SampleWpfApp.exe" KeyPath="yes" />
  </Component>

  <Component Id="MainAssembly">
    <File Source="$(var.PublishedFilesPath)\SampleWpfApp.dll" />
  </Component>

  <Component Id="AppConfiguration">
    <File Source="$(var.PublishedFilesPath)\SampleWpfApp.deps.json" />
    <File Source="$(var.PublishedFilesPath)\SampleWpfApp.runtimeconfig.json" />
  </Component>

  <!-- Debug symbols (conditional) -->
  <Component Id="DebugSymbols" Condition="$(IncludeDebugSymbols)">
    <File Source="$(var.PublishedFilesPath)\SampleWpfApp.pdb" />
  </Component>
</ComponentGroup>
```

**3.2 Runtime Components (Generated File):**
The `RuntimeComponents.wxs` file will be **automatically generated** at build time using the WiX Heat tool or HeatWave. This ensures all runtime files are included regardless of .NET version or build configuration.

**Example generated structure:**
```xml
<ComponentGroup Id="RuntimeComponents" Directory="INSTALLFOLDER">
  <!-- Generated by Heat tool scanning $(PublishedFilesPath) -->
  <Component Id="cmp_System.Private.CoreLib.dll">
    <File Source="$(var.PublishedFilesPath)\System.Private.CoreLib.dll" />
  </Component>
  <Component Id="cmp_coreclr.dll">
    <File Source="$(var.PublishedFilesPath)\coreclr.dll" />
  </Component>
  <!-- ... all other runtime files automatically included ... -->
</ComponentGroup>
```

**3.3 Subdirectory Content (Handled by SubDirectoryComponents.wxs):**
All subdirectory content (language resources, plugins, assets, etc.) will be **automatically included** by the `SubDirectoryComponents.wxs` file using WiX 6 Files elements.

**Example of what gets automatically included:**
- Language directories: `cs\*.resources.dll`, `pt-BR\*.resources.dll`
- Plugin directories: `plugins\**`
- Asset directories: `themes\**`, `assets\**`
- Any future subdirectories that .NET or applications might introduce

### 4. Enhanced Folder Structure (`Folders.wxs`)

**Changes Required:**
- Simplify directory structure since localized resources are handled dynamically
- Include shortcuts directories
- Better organization of install locations

**New Structure:**
```xml
<Fragment>
  <StandardDirectory Id="ProgramFiles6432Folder">
    <Directory Id="INSTALLFOLDER" Name="!(bind.Property.Manufacturer) !(bind.Property.ProductName)">
      <!--
        Note: Language subdirectories are now created automatically by the
        Files elements in LocalizedComponents.wxs using the Subdirectory="*" attribute.
        No need to pre-define language directories since we don't know which
        languages will be present in any given build.
      -->
    </Directory>
  </StandardDirectory>

  <!-- Desktop and Start Menu shortcuts -->
  <StandardDirectory Id="DesktopFolder" />
  <StandardDirectory Id="ProgramMenuFolder">
    <Directory Id="APPLICATIONFOLDER" Name="!(bind.Property.ProductName)" />
  </StandardDirectory>
</Fragment>
```

**Benefits of Dynamic Directory Creation:**
1. **Automatic Adaptation**: Installer adapts to whatever language directories are present
2. **No Maintenance**: No need to update directory definitions when languages change
3. **Clean Structure**: Only creates directories for languages that actually exist
4. **Future-Proof**: Works with any culture codes that .NET might introduce

### 5. Shortcuts and User Experience (New File)

**Create `Shortcuts.wxs`:**
```xml
<ComponentGroup Id="ShortcutComponents">
  <Component Id="DesktopShortcut" Directory="DesktopFolder" Condition="$(var.CreateDesktopShortcut)">
    <Shortcut
      Id="DesktopShortcut"
      Name="!(bind.Property.ProductName)"
      Target="[INSTALLFOLDER]SampleWpfApp.exe"
      WorkingDirectory="INSTALLFOLDER"
      Icon="AppIcon" />
    <RemoveFolder Id="DesktopFolder" On="uninstall" />
    <RegistryValue Root="HKCU" Key="Software\!(bind.Property.Manufacturer)\!(bind.Property.ProductName)"
                  Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes" />
  </Component>

  <Component Id="StartMenuShortcut" Directory="APPLICATIONFOLDER" Condition="$(var.CreateStartMenuShortcut)">
    <Shortcut
      Id="StartMenuShortcut"
      Name="!(bind.Property.ProductName)"
      Target="[INSTALLFOLDER]SampleWpfApp.exe"
      WorkingDirectory="INSTALLFOLDER"
      Icon="AppIcon" />
    <Shortcut
      Id="UninstallShortcut"
      Name="Uninstall !(bind.Property.ProductName)"
      Target="[SystemFolder]msiexec.exe"
      Arguments="/x [ProductCode]" />
    <RemoveFolder Id="APPLICATIONFOLDER" On="uninstall" />
    <RegistryValue Root="HKCU" Key="Software\!(bind.Property.Manufacturer)\!(bind.Property.ProductName)"
                  Name="StartMenuShortcut" Type="integer" Value="1" KeyPath="yes" />
  </Component>
</ComponentGroup>
```

### 6. Enhanced Localization (`Package.en-us.wxl`)

**Add More Localized Strings:**
```xml
<WixLocalization xmlns="http://wixtoolset.org/schemas/v4/wxl" Culture="en-US">
  <String Id="DowngradeError" Value="A newer version of [ProductName] is already installed." />
  <String Id="MainFeatureTitle" Value="!(bind.Property.ProductName) Application" />
  <String Id="MainFeatureDescription" Value="The main application files." />
  <String Id="ShortcutsFeatureTitle" Value="Shortcuts" />
  <String Id="ShortcutsFeatureDescription" Value="Desktop and Start Menu shortcuts." />
  <String Id="WelcomeMessage" Value="Welcome to the !(bind.Property.ProductName) Setup Wizard" />
</WixLocalization>
```

### 7. Build Integration Script

**Create `BuildMsi.ps1` in WixMsi folder:**
```powershell
#!/usr/bin/env pwsh
param(
    [string]$Version = "1.0.0",
    [string]$PublishedFilesPath = "..\local-published\SampleWpfApp-output",
    [string]$OutputPath = "bin\Release",
    [bool]$IncludeDebugSymbols = $false,
    [bool]$CreateDesktopShortcut = $true,
    [bool]$CreateStartMenuShortcut = $true
)

# Build MSI with parameters
$buildArgs = @(
    "build"
    "WixMsi.wixproj"
    "--configuration", "Release"
    "--property", "PackageVersion=$Version.0"
    "--property", "ProductVersion=$Version"
    "--property", "PublishedFilesPath=$PublishedFilesPath"
    "--property", "IncludeDebugSymbols=$IncludeDebugSymbols"
    "--property", "CreateDesktopShortcut=$CreateDesktopShortcut"
    "--property", "CreateStartMenuShortcut=$CreateStartMenuShortcut"
)

dotnet @buildArgs
```

### 8. Dynamic Component Generation Strategy - Using WiX 6 Files Elements

**Problem:** The published files may vary between builds, so static component files won't work.

**Recommended Solution: WiX 6 Files Elements (Replaces Deprecated Heat Tool)**

WiX 6 introduces native Files elements that provide powerful file harvesting capabilities without requiring external tools. This approach is simpler, more reliable, and integrates seamlessly with the build process.

**Key Advantages:**
- No external tool dependencies (Heat tool is deprecated)
- Native WiX 6 feature with full MSBuild integration
- Supports complex wildcard patterns and exclusion filters
- Automatically handles component generation and GUID assignment
- Built-in support for bind paths and preprocessor variables

**Implementation Approach:**

Instead of generating separate `.wxs` files, we'll use the Files elements directly in our WiX source files with parameterized paths and wildcard patterns.

**Create `RuntimeComponents.wxs`:**
```xml
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Fragment>
    <ComponentGroup Id="RuntimeComponents" Directory="INSTALLFOLDER">
      <!-- Harvest all runtime files except core application files -->
      <Files Include="$(var.PublishedFilesPath)\**"
             Exclude="$(var.PublishedFilesPath)\SampleWpfApp.exe;$(var.PublishedFilesPath)\SampleWpfApp.dll;$(var.PublishedFilesPath)\SampleWpfApp.deps.json;$(var.PublishedFilesPath)\SampleWpfApp.runtimeconfig.json">
        <!-- Exclude debug symbols unless specified -->
        <Exclude Files="$(var.PublishedFilesPath)\**.pdb"
                 Condition="'$(IncludeDebugSymbols)' != 'true'" />
        <!-- Exclude XML documentation files -->
        <Exclude Files="$(var.PublishedFilesPath)\**.xml" />
      </Files>
    </ComponentGroup>
  </Fragment>
</Wix>
```

**Create `SubDirectoryComponents.wxs`:**

**Comprehensive Subdirectory Handling (Simplified Approach):**

Instead of trying to distinguish between language and non-language folders, this approach simply includes all subdirectories and their contents, letting WiX handle the organization automatically.

```xml
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Fragment>
    <ComponentGroup Id="SubDirectoryComponents" Directory="INSTALLFOLDER">
      <!-- Include all files in all subdirectories -->
      <Files Include="$(var.PublishedFilesPath)\*\**" Subdirectory="*">
        <!-- Exclude only the problematic .NET runtime directories that we know cause issues -->
        <Exclude Files="$(var.PublishedFilesPath)\runtimes\**" />
        <Exclude Files="$(var.PublishedFilesPath)\refs\**" />
        <Exclude Files="$(var.PublishedFilesPath)\shared\**" />

        <!-- This will automatically include:
             - Language directories (cs, de, pt-BR, zh-Hans, etc.) with .resources.dll files
             - Future plugin/module directories with any file types
             - Asset directories with images, data, or other content
             - Any other subdirectories that applications or .NET might introduce
        -->
      </Files>
    </ComponentGroup>
  </Fragment>
</Wix>
```

**Key Advantages of This Simplified Approach:**

1. **Maximum Simplicity**: One component group handles everything
2. **Future-Proof**: Automatically adapts to any new subdirectory types
3. **Zero Maintenance**: No need to update exclusion lists for new content types
4. **Comprehensive**: Nothing gets missed - all subdirectories and their contents are included
5. **Clean Architecture**: Lets WiX handle the complexity of subdirectory organization
6. **Minimal Exclusions**: Only excludes the few known problematic .NET runtime directories

**How This Handles All Scenarios:**

- ✅ **Language Directories**: `cs\*.resources.dll`, `pt-BR\*.resources.dll` - automatically included
- ✅ **Plugin Directories**: `plugins\**` - automatically included
- ✅ **Asset Directories**: `assets\**`, `themes\**` - automatically included
- ✅ **Future .NET Features**: Any new subdirectories - automatically included
- ✅ **Application Features**: Module systems, extensions - automatically included

**Runtime Directory Exclusions Explained:**
- `runtimes\**` - Contains platform-specific native libraries that could conflict
- `refs\**` - Reference assemblies not needed at runtime
- `shared\**` - Shared framework files that might cause conflicts

**Update WixMsi.wixproj:**
```xml
<Project Sdk="WixToolset.Sdk/6.0.1">
  <PropertyGroup>
    <!-- Default values for parameterization -->
    <PublishedFilesPath Condition="'$(PublishedFilesPath)' == ''">$(MSBuildProjectDirectory)\..\local-published\SampleWpfApp-output</PublishedFilesPath>
    <IncludeDebugSymbols Condition="'$(IncludeDebugSymbols)' == ''">false</IncludeDebugSymbols>
    <CreateDesktopShortcut Condition="'$(CreateDesktopShortcut)' == ''">true</CreateDesktopShortcut>
    <CreateStartMenuShortcut Condition="'$(CreateStartMenuShortcut)' == ''">true</CreateStartMenuShortcut>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\src\SampleWpfApp\SampleWpfApp.csproj" />
  </ItemGroup>

  <!-- Define bind path for published files -->
  <PropertyGroup>
    <WixVariable Include="PublishedFilesPath">
      <Value>$(PublishedFilesPath)</Value>
    </WixVariable>
  </PropertyGroup>
</Project>
```

**Benefits of This Approach:**
1. **No External Dependencies:** Uses native WiX 6 functionality
2. **Reliable:** No risk of Heat tool failures or version compatibility issues
3. **Parameterized:** Supports different build scenarios through MSBuild properties
4. **Maintainable:** Clear, readable WiX source code
5. **Flexible:** Easy to add exclusion patterns or modify harvesting rules
6. **Performance:** No pre-build file generation step required

### 9. File Organization Summary

**Static Files (manually maintained):**
1. `WixMsi.wixproj` - Enhanced with parameterization and bind path configuration
2. `Package.wxs` - Parameterized package definition
3. `AppComponents.wxs` - Core application components only (4 main files)
4. `RuntimeComponents.wxs` - **NEW** - Uses Files elements to harvest .NET runtime files
5. `SubDirectoryComponents.wxs` - **NEW** - Uses Files elements to harvest all subdirectory content
6. `Shortcuts.wxs` - **NEW** - Desktop and Start Menu shortcuts
7. `Folders.wxs` - Simplified folder structure (subdirectories created dynamically)
8. `Package.en-us.wxl` - Enhanced localization
9. `BuildMsi.ps1` - **NEW** - Build script for parameterized builds

**Benefits of Using WiX 6 Files Elements with Comprehensive Subdirectory Inclusion:**
1. **Native Integration:** No external tool dependencies
2. **Parameterization:** Full support for MSBuild properties and bind paths
3. **Comprehensive:** Automatically includes all published files
4. **Maintainable:** Clear, readable source code without generated files
5. **Flexible:** Easy to add exclusion patterns and custom filtering
6. **Professional:** Proper component organization and GUID management
7. **Scalable:** Easy to extend with additional file categories
8. **Universal:** Handles all subdirectory types without classification
9. **Future-Proof:** Adapts to any new subdirectory content without code changes
10. **Simplified:** Single approach handles all scenarios

### 10. Usage Scenarios

**Local Development:**
```powershell
# After running PublishLocalSampleWpfApp.ps1
cd WixMsi
.\BuildMsi.ps1 -Version "1.2.3" -IncludeDebugSymbols $true
```

**GitHub Actions CI/CD:**
```yaml
- name: Build MSI Installer
  run: |
    cd WixMsi
    dotnet build WixMsi.wixproj --configuration Release `
      --property PackageVersion=${{ env.VERSION }}.0 `
      --property ProductVersion=${{ env.VERSION }} `
      --property PublishedFilesPath=../local-published/SampleWpfApp-output `
      --property CreateDesktopShortcut=true
```

### 11. Benefits of This Approach

1. **Modern WiX 6 Native Solution**: Uses the latest WiX 6 Files elements instead of deprecated Heat tool
2. **Parameterization**: Supports both local and CI/CD scenarios through MSBuild properties
3. **Comprehensive**: Includes all published application files through wildcard patterns
4. **Maintainable**: Organized component structure with clear source files
5. **Flexible**: Configurable features and shortcuts with conditional compilation
6. **Professional**: Proper upgrade handling and user experience
7. **Scalable**: Easy to extend with additional features and file categories
8. **Reliable**: No external tool dependencies that could break the build
9. **Performance**: No pre-build file generation steps required

### 12. Implementation Priority

1. **Phase 1**: Update project file with parameterization and bind path configuration
2. **Phase 2**: Update Package.wxs with parameterized values and component group references
3. **Phase 3**: Create static AppComponents.wxs and Shortcuts.wxs files
4. **Phase 4**: Create RuntimeComponents.wxs and LocalizedComponents.wxs using Files elements
5. **Phase 5**: Test file harvesting patterns and refine exclusion filters
6. **Phase 6**: Create build script and test parameterized builds
5. **Phase 5**: Create build scripts and validate both local and CI/CD scenarios

**Key Success Criteria:**
- ✅ All files in `$(PublishedFilesPath)` are automatically included in the installer
- ✅ Component files are regenerated for each build based on actual published content
- ✅ No manual maintenance required when .NET runtime files change
- ✅ Localized resources are automatically detected and included
- ✅ Build works in both local development and CI/CD environments

This plan provides a complete roadmap for transforming the basic WiX installer into a professional, parameterized MSI installer that **dynamically adapts to the actual published application content**. The key innovation is using the Heat tool or HeatWave to automatically generate component files at build time, ensuring the installer always includes exactly the files that were published, regardless of .NET version, build configuration, or future changes to the application dependencies.
