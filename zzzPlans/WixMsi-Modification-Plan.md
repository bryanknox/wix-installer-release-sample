# WiX 6 MSI Installer Project Modification Plan

## Project Overview
Modify the existing WiX 6 installer project to build a parameterized MSI installer for the Sample WPF Application, supporting both local development and GitHub Actions CI/CD scenarios.

## Current State Analysis

### Existing Files in WixMsi Folder:
- `WixMsi.wixproj` - Basic WiX project file with project reference
- `Package.wxs` - Main package definition with hardcoded values
- `AppComponents.wxs` - Simple component group with only 4 core files
- `Folders.wxs` - Basic folder structure definition
- `Package.en-us.wxl` - Localization file with minimal strings

### Current Limitations:
1. Only includes 4 core application files, missing ~200+ runtime dependencies
2. Hardcoded version (1.0.0.0) and other properties
3. No parameterization for different build scenarios
4. Missing desktop shortcuts, Start Menu entries, and uninstall features
5. No support for localized resource files
6. Basic folder structure without proper organization

## Modification Plan

### 1. Project File Enhancements (`WixMsi.wixproj`)

**Changes Required:**
- Add MSBuild properties for parameterization
- Define default values for local development
- Add conditional properties for CI/CD scenarios
- Include preprocessing capabilities

**New Properties to Add:**
```xml
<PropertyGroup>
  <!-- Version properties (can be overridden by build script) -->
  <PackageVersion Condition="'$(PackageVersion)' == ''">1.0.0.0</PackageVersion>
  <ProductVersion Condition="'$(ProductVersion)' == ''">1.0.0</ProductVersion>
  <ManufacturerName Condition="'$(ManufacturerName)' == ''">Bryan Knox</ManufacturerName>
  <ProductName Condition="'$(ProductName)' == ''">Sample WPF App</ProductName>

  <!-- File source properties -->
  <PublishedFilesPath Condition="'$(PublishedFilesPath)' == ''">$(MSBuildProjectDirectory)\..\local-published\SampleWpfApp-output</PublishedFilesPath>

  <!-- Build configuration -->
  <CreateDesktopShortcut Condition="'$(CreateDesktopShortcut)' == ''">true</CreateDesktopShortcut>
  <CreateStartMenuShortcut Condition="'$(CreateStartMenuShortcut)' == ''">true</CreateStartMenuShortcut>
</PropertyGroup>
```

### 2. Package Definition Updates (`Package.wxs`)

**Changes Required:**
- Replace hardcoded values with MSBuild properties
- Add upgrade logic for proper version handling
- Include proper package metadata
- Add feature organization

**Key Modifications:**
```xml
<Package
  Id="bryanknox.SampleWpfAppWixMsiPackage"
  Name="$(ProductName)"
  Manufacturer="$(ManufacturerName)"
  Version="$(PackageVersion)"
  UpgradeCode="YOUR-UPGRADE-CODE-GUID">

  <MajorUpgrade
    DowngradeErrorMessage="!(loc.DowngradeError)"
    AllowSameVersionUpgrades="yes" />

  <Feature Id="MainApplication" Title="$(ProductName)" Level="1">
    <ComponentGroupRef Id="AppComponents" />
    <ComponentGroupRef Id="RuntimeComponents" />
  </Feature>

  <Feature Id="Shortcuts" Title="Shortcuts" Level="1">
    <ComponentGroupRef Id="ShortcutComponents" />
  </Feature>
</Package>
```

### 3. Application Components Overhaul (`AppComponents.wxs`)

**Current Issues:**
- Only includes 4 files out of ~200+ required files
- Missing all .NET runtime dependencies
- No support for localized resource folders

**Solution - New Component Structure:**

**3.1 Core Application Components:**
```xml
<ComponentGroup Id="AppComponents" Directory="INSTALLFOLDER">
  <Component Id="MainExecutable">
    <File Source="$(var.PublishedFilesPath)\SampleWpfApp.exe" KeyPath="yes" />
  </Component>

  <Component Id="MainAssembly">
    <File Source="$(var.PublishedFilesPath)\SampleWpfApp.dll" />
  </Component>

  <Component Id="AppConfiguration">
    <File Source="$(var.PublishedFilesPath)\SampleWpfApp.deps.json" />
    <File Source="$(var.PublishedFilesPath)\SampleWpfApp.runtimeconfig.json" />
  </Component>

  <!-- Debug symbols (conditional) -->
  <Component Id="DebugSymbols" Condition="$(IncludeDebugSymbols)">
    <File Source="$(var.PublishedFilesPath)\SampleWpfApp.pdb" />
  </Component>
</ComponentGroup>
```

**3.2 Runtime Components (Generated File):**
The `RuntimeComponents.wxs` file will be **automatically generated** at build time using the WiX Heat tool or HeatWave. This ensures all runtime files are included regardless of .NET version or build configuration.

**Example generated structure:**
```xml
<ComponentGroup Id="RuntimeComponents" Directory="INSTALLFOLDER">
  <!-- Generated by Heat tool scanning $(PublishedFilesPath) -->
  <Component Id="cmp_System.Private.CoreLib.dll">
    <File Source="$(var.PublishedFilesPath)\System.Private.CoreLib.dll" />
  </Component>
  <Component Id="cmp_coreclr.dll">
    <File Source="$(var.PublishedFilesPath)\coreclr.dll" />
  </Component>
  <!-- ... all other runtime files automatically included ... -->
</ComponentGroup>
```

**3.3 Localized Resources (Generated Files):**
The localized component files will be **automatically generated** for each language subfolder found in the published output.

**Example generated structure:**
```xml
<ComponentGroup Id="LocalizedComponents_cs">
  <Component Id="cmp_cs_resource1" Directory="cs_DIR">
    <File Source="$(var.PublishedFilesPath)\cs\resource1.dll" />
  </Component>
  <!-- ... other Czech resources ... -->
</ComponentGroup>
```

### 4. Enhanced Folder Structure (`Folders.wxs`)

**Changes Required:**
- Add directories for localized resources
- Include shortcuts directories
- Better organization of install locations

**New Structure:**
```xml
<Fragment>
  <StandardDirectory Id="ProgramFiles6432Folder">
    <Directory Id="INSTALLFOLDER" Name="!(bind.Property.Manufacturer) !(bind.Property.ProductName)">
      <!-- Localized resource subdirectories -->
      <Directory Id="cs_DIR" Name="cs" />
      <Directory Id="de_DIR" Name="de" />
      <Directory Id="es_DIR" Name="es" />
      <!-- ... other language directories ... -->
    </Directory>
  </StandardDirectory>

  <!-- Desktop and Start Menu shortcuts -->
  <StandardDirectory Id="DesktopFolder" />
  <StandardDirectory Id="ProgramMenuFolder">
    <Directory Id="APPLICATIONFOLDER" Name="!(bind.Property.ProductName)" />
  </StandardDirectory>
</Fragment>
```

### 5. Shortcuts and User Experience (New File)

**Create `Shortcuts.wxs`:**
```xml
<ComponentGroup Id="ShortcutComponents">
  <Component Id="DesktopShortcut" Directory="DesktopFolder" Condition="$(var.CreateDesktopShortcut)">
    <Shortcut
      Id="DesktopShortcut"
      Name="!(bind.Property.ProductName)"
      Target="[INSTALLFOLDER]SampleWpfApp.exe"
      WorkingDirectory="INSTALLFOLDER"
      Icon="AppIcon" />
    <RemoveFolder Id="DesktopFolder" On="uninstall" />
    <RegistryValue Root="HKCU" Key="Software\!(bind.Property.Manufacturer)\!(bind.Property.ProductName)"
                  Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes" />
  </Component>

  <Component Id="StartMenuShortcut" Directory="APPLICATIONFOLDER" Condition="$(var.CreateStartMenuShortcut)">
    <Shortcut
      Id="StartMenuShortcut"
      Name="!(bind.Property.ProductName)"
      Target="[INSTALLFOLDER]SampleWpfApp.exe"
      WorkingDirectory="INSTALLFOLDER"
      Icon="AppIcon" />
    <Shortcut
      Id="UninstallShortcut"
      Name="Uninstall !(bind.Property.ProductName)"
      Target="[SystemFolder]msiexec.exe"
      Arguments="/x [ProductCode]" />
    <RemoveFolder Id="APPLICATIONFOLDER" On="uninstall" />
    <RegistryValue Root="HKCU" Key="Software\!(bind.Property.Manufacturer)\!(bind.Property.ProductName)"
                  Name="StartMenuShortcut" Type="integer" Value="1" KeyPath="yes" />
  </Component>
</ComponentGroup>
```

### 6. Enhanced Localization (`Package.en-us.wxl`)

**Add More Localized Strings:**
```xml
<WixLocalization xmlns="http://wixtoolset.org/schemas/v4/wxl" Culture="en-US">
  <String Id="DowngradeError" Value="A newer version of [ProductName] is already installed." />
  <String Id="MainFeatureTitle" Value="!(bind.Property.ProductName) Application" />
  <String Id="MainFeatureDescription" Value="The main application files." />
  <String Id="ShortcutsFeatureTitle" Value="Shortcuts" />
  <String Id="ShortcutsFeatureDescription" Value="Desktop and Start Menu shortcuts." />
  <String Id="WelcomeMessage" Value="Welcome to the !(bind.Property.ProductName) Setup Wizard" />
</WixLocalization>
```

### 7. Build Integration Script

**Create `BuildMsi.ps1` in WixMsi folder:**
```powershell
#!/usr/bin/env pwsh
param(
    [string]$Version = "1.0.0",
    [string]$PublishedFilesPath = "..\local-published\SampleWpfApp-output",
    [string]$OutputPath = "bin\Release",
    [bool]$IncludeDebugSymbols = $false,
    [bool]$CreateDesktopShortcut = $true,
    [bool]$CreateStartMenuShortcut = $true
)

# Build MSI with parameters
$buildArgs = @(
    "build"
    "WixMsi.wixproj"
    "--configuration", "Release"
    "--property", "PackageVersion=$Version.0"
    "--property", "ProductVersion=$Version"
    "--property", "PublishedFilesPath=$PublishedFilesPath"
    "--property", "IncludeDebugSymbols=$IncludeDebugSymbols"
    "--property", "CreateDesktopShortcut=$CreateDesktopShortcut"
    "--property", "CreateStartMenuShortcut=$CreateStartMenuShortcut"
)

dotnet @buildArgs
```

### 8. Dynamic Component Generation Strategy

**Problem:** The published files may vary between builds, so static component files won't work.

**Solution Options:**

**Option A: HeatWave Community Edition (Recommended for Visual Studio)**
- Use HeatWave's harvesting capabilities to auto-generate component files at build time
- Configure HeatWave to scan the `$(PublishedFilesPath)` folder and generate component groups
- Set up templates for consistent component generation patterns
- Enable automatic GUID generation for components

**Option B: WiX Heat Tool (Command Line)**
- Use the WiX Heat tool to generate component files as part of the build process
- Add MSBuild targets to run Heat before the WiX compilation
- Generate separate .wxs files for different file categories

**Option C: Custom MSBuild Target with Heat**
- Create MSBuild targets that run Heat to generate component files dynamically
- Integrate into the WixMsi.wixproj build process
- Generate files into intermediate directory before WiX compilation

**Recommended Implementation (Option C):**

Add to `WixMsi.wixproj`:
```xml
<PropertyGroup>
  <!-- Heat tool configuration -->
  <HeatToolPath Condition="'$(HeatToolPath)' == ''">$(WixToolPath)heat.exe</HeatToolPath>
  <GeneratedComponentsDir>$(IntermediateOutputPath)Generated</GeneratedComponentsDir>
</PropertyGroup>

<Target Name="GenerateComponents" BeforeTargets="Build">
  <!-- Create directory for generated files -->
  <MakeDir Directories="$(GeneratedComponentsDir)" />

  <!-- Generate runtime components -->
  <Exec Command='$(HeatToolPath) dir "$(PublishedFilesPath)" -cg RuntimeComponents -gg -scom -sreg -sfrag -srd -dr INSTALLFOLDER -out "$(GeneratedComponentsDir)\RuntimeComponents.wxs" -var var.PublishedFilesPath' />

  <!-- Generate localized components for each language subfolder -->
  <ItemGroup>
    <LanguageDirs Include="$(PublishedFilesPath)\*" Condition="$([System.IO.Directory]::Exists('%(FullPath)'))" />
  </ItemGroup>

  <Exec Command='$(HeatToolPath) dir "%(LanguageDirs.FullPath)" -cg LocalizedComponents_%(LanguageDirs.Filename) -gg -scom -sreg -sfrag -srd -dr %(LanguageDirs.Filename)_DIR -out "$(GeneratedComponentsDir)\LocalizedComponents_%(LanguageDirs.Filename).wxs" -var var.PublishedFilesPath'
        Condition="@(LanguageDirs->Count()) > 0" />
</Target>

<ItemGroup>
  <!-- Include generated component files -->
  <Compile Include="$(GeneratedComponentsDir)\*.wxs" />
</ItemGroup>
```

**HeatWave Configuration (if using Option A):**
- Configure auto-harvesting of the `$(PublishedFilesPath)` folder
- Set up component grouping by file type (runtime, framework, application)
- Configure exclude patterns for files that shouldn't be included (like .pdb files unless debug build)

### 9. File Organization Summary

**Static Files (manually maintained):**
1. `WixMsi.wixproj` - Enhanced with parameterization and Heat integration
2. `Package.wxs` - Parameterized package definition
3. `AppComponents.wxs` - Core application components only (4 main files)
4. `Shortcuts.wxs` - **NEW** - Desktop and Start Menu shortcuts
5. `Folders.wxs` - Enhanced folder structure with language directories
6. `Package.en-us.wxl` - Enhanced localization
7. `BuildMsi.ps1` - **NEW** - Build script for parameterized builds

**Dynamic Files (generated at build time):**
8. `RuntimeComponents.wxs` - **GENERATED** - All .NET runtime and framework files
9. `LocalizedComponents_[lang].wxs` - **GENERATED** - Localized resource files per language
10. `obj\Generated\*.wxs` - Other generated component files as needed

**File Generation Process:**
1. MSBuild target runs Heat tool before WiX compilation
2. Heat scans `$(PublishedFilesPath)` and generates component files
3. Generated files are included in the WiX compilation automatically
4. Final MSI includes all discovered files from the published output

### 10. Usage Scenarios

**Local Development:**
```powershell
# After running PublishLocalSampleWpfApp.ps1
cd WixMsi
.\BuildMsi.ps1 -Version "1.2.3" -IncludeDebugSymbols $true
```

**GitHub Actions CI/CD:**
```yaml
- name: Build MSI Installer
  run: |
    cd WixMsi
    dotnet build WixMsi.wixproj --configuration Release `
      --property PackageVersion=${{ env.VERSION }}.0 `
      --property ProductVersion=${{ env.VERSION }} `
      --property PublishedFilesPath=../local-published/SampleWpfApp-output `
      --property CreateDesktopShortcut=true
```

### 11. Benefits of This Approach

1. **Parameterization**: Supports both local and CI/CD scenarios
2. **Comprehensive**: Includes all published application files
3. **Maintainable**: Organized component structure
4. **Flexible**: Configurable features and shortcuts
5. **Professional**: Proper upgrade handling and user experience
6. **Scalable**: Easy to extend with additional features

### 12. Implementation Priority

1. **Phase 1**: Update project file with parameterization and Heat integration targets
2. **Phase 2**: Update Package.wxs with parameterized values and dynamic component references
3. **Phase 3**: Create static AppComponents.wxs and Shortcuts.wxs files
4. **Phase 4**: Set up Heat tool integration and test dynamic component generation
5. **Phase 5**: Create build scripts and validate both local and CI/CD scenarios

**Key Success Criteria:**
- ✅ All files in `$(PublishedFilesPath)` are automatically included in the installer
- ✅ Component files are regenerated for each build based on actual published content
- ✅ No manual maintenance required when .NET runtime files change
- ✅ Localized resources are automatically detected and included
- ✅ Build works in both local development and CI/CD environments

This plan provides a complete roadmap for transforming the basic WiX installer into a professional, parameterized MSI installer that **dynamically adapts to the actual published application content**. The key innovation is using the Heat tool or HeatWave to automatically generate component files at build time, ensuring the installer always includes exactly the files that were published, regardless of .NET version, build configuration, or future changes to the application dependencies.
