name: draft-vtag-release

on:
  workflow_dispatch: # Manual trigger.
  push:
    tags: ["v*"]

# Security: Restrict default permissions
permissions:
  actions: read    # Required for ci-checks workflow
  checks: write    # Required for ci-checks workflow
  contents: read

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: true       # Disable sending .NET CLI telemetry
  DOTNET_NOLOGO: true                     # Disable the .NET logo
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true # Disable the .NET first time experience
  DOTNET_VERSION: '9.0.x'
  # Environment variables for MSI packaging
  MSI_WIX_PACKAGE_ID: 'bryanknox.SampleWpfApp.5fce338'
  MSI_WIX_PLATFORM: 'x64'
  MSI_WIX_PROJ_PATH: 'WixMsi/WixMsi.wixproj'
  MSI_WIX_MANUFACTURER: 'Bryan Knox'
  # Environment variables for WPF app
  CONFIGURATION: Release
  WPF_APP_CSPROJ_PATH: src/SampleWpfApp/SampleWpfApp.csproj
  WPF_APP_RUNTIME: win-x64

jobs:

  get-version-job:
    name: Get version from v-tag job
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      release-version: ${{ steps.get-version.outputs.RELEASE_VERSION }}
    steps:
      - name: üè∑Ô∏è Get version from v-tag
        id: get-version
        shell: pwsh
        run: |
          $tagName = $env:GITHUB_REF -replace '^refs/tags/', ''
          $version = $tagName -replace '^v', ''
          Write-Host "GITHUB_REF: $env:GITHUB_REF"
          Write-Host "Tag name: $tagName"
          Write-Host "Release version: $version"
          # Output as workflow step variable.
          "RELEASE_VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

  build-publish-wpf-app-artifact-job:
    name: Build and publish WPF app artifact
    needs: get-version-job
    runs-on: windows-2022
    timeout-minutes: 20
    outputs:
      wpf-app-assembly-name: ${{ steps.get-wpf-app-names.outputs.WPF_APP_ASSEMBLY_NAME }}
      zip-artifact-name: ${{ steps.get-wpf-app-names.outputs.ZIP_ARTIFACT_NAME }}
      zip-file-name: ${{ steps.get-wpf-app-names.outputs.ZIP_FILE_NAME }}
      msi-artifact-name: ${{ steps.get-wpf-app-names.outputs.MSI_ARTIFACT_NAME }}
      msi-file-name: ${{ steps.get-wpf-app-names.outputs.MSI_NAME }}.msi
    steps:

      - name: ü§ò Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: üîß Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üîç Get WPF app names from project
        id: get-wpf-app-names
        shell: pwsh
        run: |
          # Import the module
          Import-Module "./.github/workflows/pwsh/Get-AssemblyNameOrExit.psm1" -Force

          $assemblyName = Get-AssemblyNameOrExit -ProjectPath $env:WPF_APP_CSPROJ_PATH

          Write-Host "Extracted WPF app assembly name: $assemblyName"

          $version = "${{ needs.get-version-job.outputs.release-version }}"
          $artifactNameCore = "${assemblyName}-${version}-${env:WPF_APP_RUNTIME}"

          $msiArtifactName = "${artifactNameCore}.msi"
          $msiName = "${artifactNameCore}"

          $zipArtifactName = "${artifactNameCore}-zip"
          $zipFileName = "${artifactNameCore}.zip"

          Write-Host "version: $version"
          Write-Host "zipArtifactName: $zipArtifactName"
          Write-Host "zipFileName : $zipFileName"

          # Output as workflow step variables.

          "WPF_APP_ASSEMBLY_NAME=$assemblyName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          "MSI_ARTIFACT_NAME=$msiArtifactName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          "MSI_NAME=$msiName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          "ZIP_ARTIFACT_NAME=$zipArtifactName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          "ZIP_FILE_NAME=$zipFileName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: üì¶ dotnet publish WPF app
        shell: pwsh
        run: |
          $buildNumber = $env:GITHUB_RUN_NUMBER
          $semVersion = "${{ needs.get-version-job.outputs.release-version }}"
          $semVersionDotZero  = ($semVersion + ".0")
          $semVersionDotBuildNumber = "$semVersion.$buildNumber"
          $wpfAppPubOutputPath = "${{ runner.temp }}/wpf-pub-output"

          Write-Host "semVersionDotZero: $semVersionDotZero"
          Write-Host "semVersionDotBuildNumber: $semVersionDotBuildNumber"

          dotnet publish `
            $env:WPF_APP_CSPROJ_PATH `
            --configuration $env:CONFIGURATION `
            --self-contained `
            --runtime $env:WPF_APP_RUNTIME `
            --output $wpfAppPubOutputPath `
            --verbosity minimal `
            -p:Version=$semVersion `
            -p:AssemblyVersion=$semVersionDotZero  `
            -p:FileVersion=$semVersionDotZero  `
            -p:InformationalVersion=$semVersionDotBuildNumber `
            -p:IncludeSourceRevisionInInformationalVersion=true

      - name: üì¶ Create Zip archive of WPF app
        shell: pwsh
        run: |
          $wpfAppPublishedOutputPath = "${{ runner.temp }}/wpf-pub-output"
          $zipPath = Join-Path "${{ runner.temp }}" "${{ steps.get-wpf-app-names.outputs.ZIP_FILE_NAME }}"
          Compress-Archive -Path "$wpfAppPublishedOutputPath\*" -DestinationPath $zipPath -Force
          Write-Host "Created zip archive: $zipPath"

      - name: üì§ Upload Zip to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "${{ steps.get-wpf-app-names.outputs.ZIP_ARTIFACT_NAME }}"
          path: "${{ runner.temp }}/${{ steps.get-wpf-app-names.outputs.ZIP_FILE_NAME }}"
          retention-days: 7
          if-no-files-found: error

      - name: üì¶ Create MSI for WPF app
        shell: pwsh
        env:
          STEP_PACKAGE_VERSION: ${{ needs.get-version-job.outputs.release-version }}.${{ github.run_number }}
          STEP_PRODUCT_NAME: ${{ steps.get-wpf-app-names.outputs.WPF_APP_ASSEMBLY_NAME }}
          STEP_MAIN_EXECUTABLE_FILE_NAME: ${{ steps.get-wpf-app-names.outputs.WPF_APP_ASSEMBLY_NAME }}.exe
          STEP_MSI_FILE_NAME_WITH_OUT_EXT: ${{ steps.get-wpf-app-names.outputs.MSI_NAME }}
        run: |
          $wpfAppPubOutputPath = "${{ runner.temp }}/wpf-pub-output"
          $msiWixOutputPath = "${{ runner.temp }}/msi-output"

          dotnet build `
            $env:MSI_WIX_PROJ_PATH `
            --configuration $env:CONFIGURATION `
            --verbosity minimal `
            -p:PackageId=$env:MSI_WIX_PACKAGE_ID `
            -p:PackageVersion=$env:STEP_PACKAGE_VERSION `
            -p:Platform=$env:MSI_WIX_PLATFORM `
            -p:ProductName=$env:STEP_PRODUCT_NAME `
            -p:Manufacturer=$env:MSI_WIX_MANUFACTURER `
            -p:PublishedFilesPath=$wpfAppPubOutputPath `
            -p:MsiFileName=$env:STEP_MSI_FILE_NAME_WITH_OUT_EXT `
            -p:OutputPath=$msiWixOutputPath

      - name: üì§ Upload MSI to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "${{ steps.get-wpf-app-names.outputs.MSI_ARTIFACT_NAME }}"
          path: "${{ runner.temp }}/msi-output/en-US/*.msi"
          retention-days: 7
          if-no-files-found: error

  draft-release-wpf-app-job:
    name: Create draft release for WPF app
    runs-on: ubuntu-latest
    needs: [get-version-job, build-publish-wpf-app-artifact-job]
    timeout-minutes: 10
    permissions:
      contents: write
    steps:

      - name: ü§ò Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0  # Needs full depth for generating release notes

      - name: üì• Download zip artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-publish-wpf-app-artifact-job.outputs.zip-artifact-name }}
          path: ${{ runner.temp }}/dist

      - name: üì• Download MSI artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-publish-wpf-app-artifact-job.outputs.msi-artifact-name }}
          path: ${{ runner.temp }}/dist

      - name: üìù Generate release notes
        id: release-notes
        shell: pwsh
        run: |
          # Use the version extracted from the get-version-job
          $version = "${{ needs.get-version-job.outputs.release-version }}"

          $artifactZipName = "${{ needs.build-publish-wpf-app-artifact-job.outputs.zip-file-name }}"
          $artifactMsiName = "${{ needs.build-publish-wpf-app-artifact-job.outputs.msi-file-name }}"
          $appName = "${{ needs.build-publish-wpf-app-artifact-job.outputs.wpf-app-assembly-name }}"
          $exeName = "${{ needs.build-publish-wpf-app-artifact-job.outputs.wpf-app-assembly-name }}.exe"

          Write-Host "version: $version"
          Write-Host "artifactZipName: $artifactZipName"
          Write-Host "artifactMsiName: $artifactMsiName"
          Write-Host "appName: $appName"
          Write-Host "exeName: $exeName"

          # Create release notes using StringBuilder for multiline content
          $sb = [System.Text.StringBuilder]::new()
          [void]$sb.AppendLine("## v$version $appName")
          [void]$sb.AppendLine("")
          [void]$sb.AppendLine("### What's New")
          [void]$sb.AppendLine("This release includes the latest features and improvements for $appName.")
          [void]$sb.AppendLine("")
          [void]$sb.AppendLine("### Download")
          [void]$sb.AppendLine("- **Windows (x64) Portable**: Download the zip file from the assets below")
          [void]$sb.AppendLine("- **Windows (x64) Installer**: Download the MSI file from the assets below")
          [void]$sb.AppendLine("")
          [void]$sb.AppendLine("### Verification")
          [void]$sb.AppendLine("1. Download the ``$artifactZipName`` or ``$artifactMsiName`` file from the GitHub release assets")
          [void]$sb.AppendLine("2. Copy the SHA256 for the downloaded file from the GitHub release assets")
          [void]$sb.AppendLine("3. Verify the file integrity: ``Get-FileHash <filename> -Algorithm SHA256``")
          [void]$sb.AppendLine("4. Compare with the hash returned with the SHA256 from GitHub")
          [void]$sb.AppendLine("")
          [void]$sb.AppendLine("### Installation")
          [void]$sb.AppendLine("#### Portable (Zip)")
          [void]$sb.AppendLine("1. Download and verify the zip file (see Verification above)")
          [void]$sb.AppendLine("2. Extract the zip file to your desired location")
          [void]$sb.AppendLine("3. Run ``$exeName`` to start the application")
          [void]$sb.AppendLine("")
          [void]$sb.AppendLine("#### Installer (MSI)")
          [void]$sb.AppendLine("1. Download and verify the MSI file (see Verification above)")
          [void]$sb.AppendLine("2. Run the MSI installer to install the application")
          [void]$sb.AppendLine("3. Launch the application from the Start Menu or Desktop shortcut")
          [void]$sb.AppendLine("")
          [void]$sb.AppendLine("### System Requirements")
          [void]$sb.AppendLine("- Windows 10 version 1809 or later")
          [void]$sb.AppendLine("- .NET 9.0 Runtime (included in self-contained build)")

          $sb.ToString() | Out-File -FilePath "release-notes.md" -Encoding utf8
          Write-Host "Generated release notes"

      - name: üöÄ Create draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          fail_on_unmatched_files: true
          name: v${{ needs.get-version-job.outputs.release-version }} ${{ needs.build-publish-wpf-app-artifact-job.outputs.wpf-app-assembly-name }}
          tag_name: ${{ github.ref_name }}
          body_path: release-notes.md
          files: |
            ${{ runner.temp }}/dist/*
